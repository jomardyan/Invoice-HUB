// @ts-nocheck
import { MonitoringService } from '@/services/MonitoringService';  describe('MonitoringService', () => {   let monitoringService: MonitoringService;    beforeEach(() => {     monitoringService = new MonitoringService();   });    describe('Sentry integration', () => {     it('should initialize Sentry', () => {       const dsn = 'https://example@example.ingest.sentry.io/123456';       expect(dsn).toContain('sentry.io');     });      it('should set Sentry environment', () => {       const environment = 'production';       expect(environment).toBe('production');     });      it('should track Sentry release version', () => {       const release = '1.0.0';       expect(release).toBeDefined();     });      it('should configure Sentry sampling rate', () => {       const tracesSampleRate = 0.1; // 10%       expect(tracesSampleRate).toBeLessThanOrEqual(1);       expect(tracesSampleRate).toBeGreaterThanOrEqual(0);     });   });    describe('error tracking', () => {     it('should capture JavaScript errors', () => {       const error = new Error('Test error');       expect(error.message).toBe('Test error');     });      it('should track error context', () => {       const errorContext = {         error: 'Database connection failed',         userId: 'user-123',         service: 'InvoiceService',         timestamp: new Date(),       };        expect(errorContext.userId).toBeDefined();       expect(errorContext.service).toBeDefined();     });      it('should categorize error severity', () => {       const severities = ['fatal', 'error', 'warning', 'info', 'debug'];       expect(severities).toContain('fatal');     });      it('should track stack traces', () => {       const stackTrace = {         frames: [           { filename: 'services/InvoiceService.ts', function: 'createInvoice' },           { filename: 'routes/invoices.ts', function: 'post' },         ],       };        expect(stackTrace.frames.length).toBeGreaterThan(0);     });   });    describe('request monitoring', () => {     it('should track HTTP request start', () => {       const request = {         id: 'req-123',         method: 'POST',         path: '/api/invoices',         startTime: new Date(),       };        expect(request.id).toBeDefined();       expect(request.startTime).toBeDefined();     });      it('should track HTTP response end', () => {       const response = {         statusCode: 200,         responseTime: 145, // ms         endTime: new Date(),       };        expect(response.statusCode).toBe(200);       expect(response.responseTime).toBeGreaterThan(0);     });      it('should measure request duration', () => {       const startTime = Date.now();       // Simulate request       const endTime = Date.now();       const duration = endTime - startTime;        expect(duration).toBeGreaterThanOrEqual(0);     });      it('should track request headers', () => {       const headers = {         'content-type': 'application/json',         'authorization': 'Bearer token123',         'user-agent': 'Mozilla/5.0',       };        expect(headers['content-type']).toBe('application/json');     });      it('should track request body size', () => {       const body = JSON.stringify({ invoiceNumber: 'INV-001' });       const size = Buffer.byteLength(body, 'utf8');        expect(size).toBeGreaterThan(0);     });   });    describe('performance monitoring (APM)', () => {     it('should track transaction', () => {       const transaction = {         name: 'POST /api/invoices',         op: 'http.server',         startTime: Date.now(),         duration: 250,       };        expect(transaction.name).toBeDefined();       expect(transaction.duration).toBeGreaterThan(0);     });      it('should track spans within transaction', () => {       const spans = [         { op: 'db.query', duration: 100 },         { op: 'template.render', duration: 50 },         { op: 'email.send', duration: 100 },       ];        const totalDuration = spans.reduce((sum, s) => sum + s.duration, 0);       expect(totalDuration).toBe(250);     });      it('should measure database query performance', () => {       const queryMetrics = {         query: 'SELECT * FROM invoices',         duration: 85, // ms         rowCount: 50,       };        expect(queryMetrics.duration).toBeLessThan(200);     });      it('should measure external API calls', () => {       const apiCall = {         service: 'Allegro',         endpoint: '/api/offers',         duration: 450, // ms         statusCode: 200,       };        expect(apiCall.duration).toBeGreaterThan(0);     });      it('should measure template rendering', () => {       const templateRender = {         template: 'invoice.html',         duration: 45, // ms         variables: 32,       };        expect(templateRender.duration).toBeLessThan(100);     });   });    describe('metrics collection', () => {     it('should track request rate', () => {       const requestsPerSecond = 150;       expect(requestsPerSecond).toBeGreaterThan(0);     });      it('should track error rate', () => {       const totalRequests = 1000;       const erroredRequests = 15;       const errorRate = (erroredRequests / totalRequests) * 100;        expect(errorRate).toBe(1.5);     });      it('should track response time distribution', () => {       const metrics = {         p50: 85, // 50th percentile         p95: 450,         p99: 2000,       };        expect(metrics.p50).toBeLessThan(metrics.p95);       expect(metrics.p95).toBeLessThan(metrics.p99);     });      it('should track database metrics', () => {       const dbMetrics = {         connectionPoolSize: 10,         activeConnections: 8,         queryCount: 5420,         slowQueries: 12,       };        expect(dbMetrics.activeConnections).toBeLessThanOrEqual(dbMetrics.connectionPoolSize);     });      it('should track memory usage', () => {       const memory = {         heapUsed: 125.5, // MB         heapTotal: 256,         external: 12.3,         rss: 320,       };        expect(memory.heapUsed).toBeLessThan(memory.heapTotal);     });      it('should track CPU usage', () => {       const cpu = {         user: 45.2, // percentage         system: 12.1,         total: 57.3,       };        expect(cpu.total).toBeLessThanOrEqual(100);     });   });    describe('alert thresholds', () => {     it('should alert on high error rate', () => {       const errorRate = 5; // 5%       const threshold = 1;       const shouldAlert = errorRate > threshold;        expect(shouldAlert).toBe(true);     });      it('should alert on slow response times', () => {       const p95ResponseTime = 2000; // ms       const threshold = 1000; // ms       const shouldAlert = p95ResponseTime > threshold;        expect(shouldAlert).toBe(true);     });      it('should alert on high memory usage', () => {       const heapUsed = 450; // MB       const heapTotal = 500;       const usage = (heapUsed / heapTotal) * 100;       const threshold = 80; // 80%       const shouldAlert = usage > threshold;        expect(shouldAlert).toBe(true);     });      it('should alert on database connection pool exhaustion', () => {       const activeConnections = 10;       const poolSize = 10;       const isFull = activeConnections === poolSize;        expect(isFull).toBe(true);     });   });    describe('breadcrumbs', () => {     it('should record user action breadcrumb', () => {       const breadcrumb = {         message: 'User clicked create invoice button',         level: 'info',         timestamp: new Date(),         category: 'user-action',       };        expect(breadcrumb.category).toBe('user-action');     });      it('should record HTTP breadcrumb', () => {       const breadcrumb = {         message: 'POST /api/invoices',         level: 'info',         statusCode: 200,         category: 'http',       };        expect(breadcrumb.category).toBe('http');     });      it('should record database breadcrumb', () => {       const breadcrumb = {         message: 'SELECT * FROM invoices',         level: 'info',         duration: 85,         category: 'database',       };        expect(breadcrumb.category).toBe('database');     });      it('should limit breadcrumbs to 100', () => {       const maxBreadcrumbs = 100;       expect(maxBreadcrumbs).toBe(100);     });   });    describe('user context', () => {     it('should attach user ID to events', () => {       const context = {         userId: 'user-123',         email: 'user@example.com',         tenant: 'tenant-456',       };        expect(context.userId).toBeDefined();     });      it('should include user session info', () => {       const session = {         sessionId: 'sess-789',         createdAt: new Date(),         expiresAt: new Date(Date.now() + 3600000),       };        expect(session.sessionId).toBeDefined();     });   });    describe('custom metrics', () => {     it('should track invoice created event', () => {       const metric = {         event: 'invoice.created',         invoiceId: 'inv-001',         customerId: 'cust-123',         amount: 1000,         timestamp: new Date(),       };        expect(metric.event).toBe('invoice.created');     });      it('should track payment processed event', () => {       const metric = {         event: 'payment.processed',         paymentId: 'pay-001',         invoiceId: 'inv-001',         amount: 1000,         provider: 'stripe',         timestamp: new Date(),       };        expect(metric.event).toBe('payment.processed');     });      it('should track export completed event', () => {       const metric = {         event: 'export.completed',         exportId: 'exp-001',         format: 'pdf',         recordCount: 500,         duration: 2500, // ms         timestamp: new Date(),       };        expect(metric.event).toBe('export.completed');     });   });    describe('log aggregation', () => {     it('should log with structured format', () => {       const log = {         timestamp: new Date(),         level: 'info',         message: 'Invoice created',         service: 'InvoiceService',         context: { invoiceId: 'inv-001' },       };        expect(log.level).toBe('info');       expect(log.service).toBeDefined();     });      it('should include trace ID for correlation', () => {       const log = {         traceId: 'trace-123abc',         spanId: 'span-456def',         message: 'Processing request',       };        expect(log.traceId).toBeDefined();       expect(log.spanId).toBeDefined();     });   });    describe('sampling strategies', () => {     it('should sample errors at 100%', () => {       const errorSampleRate = 1.0; // 100%       expect(errorSampleRate).toBe(1.0);     });      it('should sample transactions at rate', () => {       const transactionSampleRate = 0.1; // 10%       expect(transactionSampleRate).toBe(0.1);     });      it('should apply dynamic sampling based on error rate', () => {       const baseRate = 0.1;       const errorRate = 5; // 5%       const dynamicRate = errorRate > 1 ? 0.5 : baseRate;        expect(dynamicRate).toBe(0.5);     });   });    describe('data privacy', () => {     it('should redact sensitive data', () => {       const message = 'User logged in with email: user@example.com and password: secret123';       const redacted = message.replace(/password: \S+/g, 'password: [REDACTED]');        expect(redacted).not.toContain('secret123');       expect(redacted).toContain('[REDACTED]');     });      it('should exclude PII from breadcrumbs', () => {       const breadcrumb = {         message: 'Created user account',         userId: 'user-123', // ID is ok         email: '[REDACTED]', // email is redacted       };        expect(breadcrumb.userId).toBeDefined();       expect(breadcrumb.email).toBe('[REDACTED]');     });   });    describe('health checks', () => {     it('should verify Sentry connectivity', () => {       const isConnected = true;       expect(isConnected).toBe(true);     });      it('should check monitoring service health', () => {       const health = {         status: 'healthy',         lastCheck: new Date(),         responseTime: 45,       };        expect(health.status).toBe('healthy');     });   });    describe('retention policies', () => {     it('should retain errors for 30 days', () => {       const retentionDays = 30;       expect(retentionDays).toBe(30);     });      it('should retain transactions for 7 days', () => {       const retentionDays = 7;       expect(retentionDays).toBe(7);     });      it('should apply tiered retention based on severity', () => {       const retention = {         fatal: 90,         error: 30,         warning: 14,         info: 7,       };        expect(retention.fatal).toBeGreaterThan(retention.error);     });   }); });
