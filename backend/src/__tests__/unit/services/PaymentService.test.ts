// @ts-nocheck
import { PaymentService, CreatePaymentInput, PaymentRefund } from '@/services/PaymentService'; import { PaymentProvider, PaymentStatus } from '@/entities/Payment';  jest.mock('uuid', () => ({   v4: jest.fn(() => 'mocked-uuid-v4'), }));  jest.mock('stripe');  describe('PaymentService', () => {   let paymentService: PaymentService;    beforeEach(() => {     paymentService = new PaymentService();   });    describe('payment providers', () => {     it('should support Stripe payments', () => {       expect(PaymentProvider.STRIPE).toBe('stripe');     });      it('should support Bank transfer', () => {       expect(PaymentProvider.BANK_TRANSFER).toBe('bank_transfer');     });      it('should support Manual payment', () => {       expect(PaymentProvider.MANUAL).toBe('manual');     });   });    describe('payment creation', () => {     it('should create Stripe payment', () => {       const input: CreatePaymentInput = {         invoiceId: 'inv-123',         provider: PaymentProvider.STRIPE,         amount: 500,         currency: 'PLN',       };        expect(input.provider).toBe(PaymentProvider.STRIPE);       expect(input.amount).toBeGreaterThan(0);     });      it('should validate payment amount', () => {       const input: CreatePaymentInput = {         invoiceId: 'inv-123',         provider: PaymentProvider.BANK_TRANSFER,         amount: -100,       };        expect(input.amount).toBeLessThan(0); // Should be rejected     });      it('should prevent overpayment', () => {       const invoiceTotal = 500;       const paymentAmount = 600;        const isOverpayment = paymentAmount > invoiceTotal;       expect(isOverpayment).toBe(true);     });      it('should support partial payments', () => {       const invoiceTotal = 500;       const payment1 = 200;       const payment2 = 300;        expect(payment1 + payment2).toBe(invoiceTotal);     });   });    describe('payment status', () => {     it('should have pending status initially', () => {       expect(PaymentStatus.PENDING).toBe('pending');     });      it('should transition to processing', () => {       expect(PaymentStatus.PROCESSING).toBe('processing');     });      it('should transition to succeeded', () => {       expect(PaymentStatus.SUCCEEDED).toBe('succeeded');     });      it('should transition to failed', () => {       expect(PaymentStatus.FAILED).toBe('failed');     });      it('should support cancelled status', () => {       expect(PaymentStatus.CANCELLED).toBe('cancelled');     });   });    describe('Stripe integration', () => {     it('should create payment intent with Stripe', () => {       const input: CreatePaymentInput = {         invoiceId: 'inv-123',         provider: PaymentProvider.STRIPE,         amount: 500,         currency: 'PLN',         metadata: { invoiceId: 'inv-123' },       };        expect(input.metadata?.invoiceId).toBe('inv-123');     });      it('should generate client secret for frontend', () => {       const clientSecret = 'pi_1234567890_secret_abcdef';       expect(clientSecret).toContain('secret');     });      it('should handle Stripe webhooks', () => {       const webhookEvent = {         type: 'payment_intent.succeeded',         data: { object: { id: 'pi_123' } },       };        expect(webhookEvent.type).toContain('payment_intent');     });   });    describe('payment refunds', () => {     it('should refund full payment amount', () => {       const refund: PaymentRefund = {         paymentId: 'pay-123',       };        expect(refund.paymentId).toBeDefined();     });      it('should refund partial amount', () => {       const refund: PaymentRefund = {         paymentId: 'pay-123',         amount: 250, // Half of 500       };        expect(refund.amount).toBeLessThan(500);     });      it('should record refund reason', () => {       const refund: PaymentRefund = {         paymentId: 'pay-123',         reason: 'Customer request',       };        expect(refund.reason).toBeDefined();     });      it('should update invoice status after refund', () => {       const originalStatus = PaymentStatus.SUCCEEDED;       const afterRefund = PaymentStatus.REFUNDED;        expect(originalStatus).not.toBe(afterRefund);     });   });    describe('payment methods', () => {     it('should support card payments', () => {       const method = 'card';       expect(method).toBe('card');     });      it('should support bank transfer', () => {       const method = 'bank_transfer';       expect(method).toBe('bank_transfer');     });      it('should store payment method safely', () => {       const lastFourDigits = '1234';       expect(lastFourDigits).toHaveLength(4);     });   });    describe('invoice reconciliation', () => {     it('should mark invoice as paid when fully paid', () => {       const invoiceTotal = 500;       const totalPaid = 500;        const isPaid = totalPaid >= invoiceTotal;       expect(isPaid).toBe(true);     });      it('should track partial payment status', () => {       const invoiceTotal = 500;       const paid = 300;       const remaining = invoiceTotal - paid;        expect(remaining).toBe(200);     });   });    describe('payment history', () => {     it('should maintain payment history', () => {       const payments = [         { id: 'pay-1', amount: 200, date: new Date('2024-01-01') },         { id: 'pay-2', amount: 300, date: new Date('2024-01-05') },       ];        expect(payments).toHaveLength(2);       expect(payments[0].date < payments[1].date).toBe(true);     });   });    describe('error handling', () => {     it('should handle insufficient funds error', () => {       const error = 'Your card has insufficient funds';       expect(error).toContain('insufficient funds');     });      it('should handle expired card error', () => {       const error = 'Your card has expired';       expect(error).toContain('expired');     });      it('should handle declined payment', () => {       const error = 'Your payment was declined';       expect(error).toContain('declined');     });   });    describe('currency support', () => {     it('should support PLN currency', () => {       const currency = 'PLN';       expect(currency).toBe('PLN');     });      it('should support EUR currency', () => {       const currency = 'EUR';       expect(currency).toBe('EUR');     });      it('should support USD currency', () => {       const currency = 'USD';       expect(currency).toBe('USD');     });   });    describe('audit trail', () => {     it('should log all payment transactions', () => {       const log = {         paymentId: 'pay-123',         action: 'payment_created',         timestamp: new Date(),       };        expect(log.paymentId).toBeDefined();       expect(log.timestamp).toBeDefined();     });      it('should track payment modifications', () => {       const actions = [         { action: 'created', time: new Date('2024-01-01T10:00:00') },         { action: 'succeeded', time: new Date('2024-01-01T10:05:00') },       ];        expect(actions[0].time < actions[1].time).toBe(true);     });   }); });
