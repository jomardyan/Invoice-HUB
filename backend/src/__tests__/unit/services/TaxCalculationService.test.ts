// @ts-nocheck
import { TaxCalculationService, TaxCalculationInput, TaxCalculationResult } from '@/services/TaxCalculationService';  describe('TaxCalculationService', () => {   let taxService: TaxCalculationService;    beforeEach(() => {     taxService = new TaxCalculationService();   });    describe('Polish VAT rates', () => {     it('should apply 23% standard VAT rate', () => {       const input: TaxCalculationInput = {         netAmount: 100,         vatRate: 23,       };        const tax = input.netAmount * (input.vatRate / 100);       const gross = input.netAmount + tax;        expect(tax).toBe(23);       expect(gross).toBe(123);     });      it('should apply 8% reduced VAT rate', () => {       const input: TaxCalculationInput = {         netAmount: 100,         vatRate: 8,       };        const tax = input.netAmount * (input.vatRate / 100);       expect(tax).toBe(8);     });      it('should apply 5% super-reduced VAT rate', () => {       const input: TaxCalculationInput = {         netAmount: 100,         vatRate: 5,       };        const tax = input.netAmount * (input.vatRate / 100);       expect(tax).toBe(5);     });      it('should apply 0% zero VAT rate (exemptions)', () => {       const input: TaxCalculationInput = {         netAmount: 100,         vatRate: 0,       };        const tax = input.netAmount * (input.vatRate / 100);       expect(tax).toBe(0);     });   });    describe('EU VAT rates', () => {     it('should support Germany standard rate (19%)', () => {       const input: TaxCalculationInput = {         netAmount: 100,         vatRate: 19,         countryCode: 'DE',       };        const tax = input.netAmount * (input.vatRate / 100);       expect(tax).toBe(19);     });      it('should support France standard rate (20%)', () => {       const input: TaxCalculationInput = {         netAmount: 100,         vatRate: 20,         countryCode: 'FR',       };        const tax = input.netAmount * (input.vatRate / 100);       expect(tax).toBe(20);     });      it('should support Italy standard rate (22%)', () => {       const input: TaxCalculationInput = {         netAmount: 100,         vatRate: 22,         countryCode: 'IT',       };        const tax = input.netAmount * (input.vatRate / 100);       expect(tax).toBe(22);     });      it('should support Spain standard rate (21%)', () => {       const input: TaxCalculationInput = {         netAmount: 100,         vatRate: 21,         countryCode: 'ES',       };        const tax = input.netAmount * (input.vatRate / 100);       expect(tax).toBe(21);     });      it('should support UK standard rate (20%)', () => {       const input: TaxCalculationInput = {         netAmount: 100,         vatRate: 20,         countryCode: 'UK',       };        const tax = input.netAmount * (input.vatRate / 100);       expect(tax).toBe(20);     });   });    describe('tax calculation', () => {     it('should calculate tax on net amount', () => {       const input: TaxCalculationInput = {         netAmount: 1000,         vatRate: 23,       };        const tax = input.netAmount * (input.vatRate / 100);       expect(tax).toBe(230);     });      it('should calculate gross amount', () => {       const input: TaxCalculationInput = {         netAmount: 1000,         vatRate: 23,       };        const tax = input.netAmount * (input.vatRate / 100);       const gross = input.netAmount + tax;        expect(gross).toBe(1230);     });      it('should handle decimal amounts', () => {       const input: TaxCalculationInput = {         netAmount: 99.99,         vatRate: 23,       };        const tax = input.netAmount * (input.vatRate / 100);       expect(Math.round(tax * 100) / 100).toBeCloseTo(22.9977);     });      it('should return complete tax calculation result', () => {       const input: TaxCalculationInput = {         netAmount: 1000,         vatRate: 23,       };        const tax = input.netAmount * (input.vatRate / 100);       const result: TaxCalculationResult = {         netAmount: input.netAmount,         discountAmount: 0,         taxableAmount: input.netAmount,         taxAmount: tax,         grossAmount: input.netAmount + tax,         vatRate: input.vatRate,         calculatedAt: new Date(),       };        expect(result.netAmount).toBe(1000);       expect(result.taxAmount).toBe(230);       expect(result.grossAmount).toBe(1230);     });   });    describe('discount handling', () => {     it('should apply discount before tax calculation', () => {       const input: TaxCalculationInput = {         netAmount: 1000,         vatRate: 23,         discountPercent: 10,       };        const discountAmount = input.netAmount * (input.discountPercent! / 100);       const taxableAmount = input.netAmount - discountAmount;       const tax = taxableAmount * (input.vatRate / 100);       const gross = taxableAmount + tax;        expect(discountAmount).toBe(100);       expect(taxableAmount).toBe(900);       expect(tax).toBe(207);       expect(gross).toBe(1107);     });      it('should handle various discount percentages', () => {       const discounts = [5, 10, 15, 20, 25];       const netAmount = 1000;        discounts.forEach(discount => {         const discountAmount = netAmount * (discount / 100);         expect(discountAmount).toBeGreaterThan(0);         expect(discountAmount).toBeLessThan(netAmount);       });     });   });    describe('mixed VAT rates', () => {     it('should calculate invoice with multiple VAT rates', () => {       const items = [         { net: 100, vat: 23 },         { net: 100, vat: 8 },         { net: 100, vat: 0 },       ];        const totals = items.reduce(         (acc, item) => {           const tax = item.net * (item.vat / 100);           return {             net: acc.net + item.net,             tax: acc.tax + tax,             gross: acc.gross + item.net + tax,           };         },         { net: 0, tax: 0, gross: 0 }       );        expect(totals.net).toBe(300);       expect(totals.tax).toBe(31); // 23 + 8 + 0       expect(totals.gross).toBe(331);     });      it('should break down by VAT rate', () => {       const items = [         { amount: 100, rate: 23 },         { amount: 50, rate: 8 },       ];        const breakdown = items.map(item => ({         rate: item.rate,         net: item.amount,         tax: item.amount * (item.rate / 100),       }));        expect(breakdown).toHaveLength(2);       expect(breakdown[0].tax).toBe(23);       expect(breakdown[1].tax).toBe(4);     });   });    describe('reverse charge mechanism', () => {     it('should apply reverse charge for EU B2B transactions', () => {       const isEUTransaction = true;       const isBusiness = true;       const isReverseChargeApplicable = isEUTransaction && isBusiness;        expect(isReverseChargeApplicable).toBe(true);     });      it('should set tax to zero for reverse charge', () => {       const input: TaxCalculationInput = {         netAmount: 1000,         vatRate: 0, // Reverse charge = 0% VAT       };        const tax = input.netAmount * (input.vatRate / 100);       expect(tax).toBe(0);     });   });    describe('tax exemptions', () => {     it('should handle tax-exempt products', () => {       const input: TaxCalculationInput = {         netAmount: 1000,         vatRate: 0, // Exempt       };        const tax = input.netAmount * (input.vatRate / 100);       const gross = input.netAmount + tax;        expect(tax).toBe(0);       expect(gross).toBe(1000);     });      it('should apply small business exemption', () => {       const annualRevenue = 40000; // Below threshold in Poland       const isExempt = annualRevenue < 50000; // Polish threshold        expect(isExempt).toBe(true);     });   });    describe('tax calculation validation', () => {     it('should validate VAT rate range', () => {       const validRates = [0, 5, 8, 23];       const invalidRates = [-5, 101];        validRates.forEach(rate => {         expect(rate).toBeGreaterThanOrEqual(0);         expect(rate).toBeLessThanOrEqual(100);       });        invalidRates.forEach(rate => {         expect(rate < 0 || rate > 100).toBe(true);       });     });      it('should validate net amount is positive', () => {       const validAmounts = [0.01, 10, 1000];       const invalidAmounts = [-10, -0.01];        validAmounts.forEach(amount => {         expect(amount).toBeGreaterThan(0);       });        invalidAmounts.forEach(amount => {         expect(amount).toBeLessThan(0);       });     });      it('should handle rounding correctly', () => {       const input: TaxCalculationInput = {         netAmount: 333.33,         vatRate: 23,       };        const tax = input.netAmount * (input.vatRate / 100);       const rounded = Math.round(tax * 100) / 100;        expect(rounded).toBeCloseTo(76.67);     });   });    describe('cross-border transactions', () => {     it('should identify EU transaction', () => {       const countryCode = 'DE';       const isEU = ['DE', 'FR', 'IT', 'ES', 'PL'].includes(countryCode);        expect(isEU).toBe(true);     });      it('should validate VIES for VAT-EU numbers', () => {       const vatEU = 'PL1234567890';       const vatEURegex = /^[A-Z]{2}\d{10,}$/;        expect(vatEURegex.test(vatEU)).toBe(true);     });   });    describe('reporting and summaries', () => {     it('should generate monthly tax summary', () => {       const transactions = [         { amount: 1000, rate: 23, date: new Date('2024-01-15') },         { amount: 500, rate: 8, date: new Date('2024-01-20') },       ];        const totalTax = transactions.reduce(         (sum, t) => sum + (t.amount * (t.rate / 100)),         0       );        expect(totalTax).toBe(270);     });      it('should track tax by rate', () => {       const transactions = [         { amount: 1000, rate: 23 },         { amount: 500, rate: 23 },         { amount: 300, rate: 8 },       ];        const byRate = transactions.reduce((acc, t) => {         if (!acc[t.rate]) acc[t.rate] = 0;         acc[t.rate] += t.amount * (t.rate / 100);         return acc;       }, {} as Record<number, number>);        expect(byRate[23]).toBe(345);       expect(byRate[8]).toBe(24);     });   });    describe('audit trail', () => {     it('should record calculation timestamp', () => {       const now = new Date();       const result: TaxCalculationResult = {         netAmount: 1000,         discountAmount: 0,         taxableAmount: 1000,         taxAmount: 230,         grossAmount: 1230,         vatRate: 23,         calculatedAt: now,       };        expect(result.calculatedAt).toEqual(now);     });      it('should log all tax calculations for audit', () => {       const logs = [         { invoiceId: 'INV-001', taxAmount: 230, timestamp: new Date() },         { invoiceId: 'INV-002', taxAmount: 115, timestamp: new Date() },       ];        expect(logs).toHaveLength(2);       logs.forEach(log => {         expect(log.invoiceId).toBeDefined();         expect(log.taxAmount).toBeGreaterThan(0);       });     });   }); });
