// @ts-nocheck
import { TemplateService, TemplateCreateInput, TemplateRenderInput } from '@/services/TemplateService';  jest.mock('uuid', () => ({   v4: jest.fn(() => 'mocked-uuid-v4'), }));  describe('TemplateService', () => {   let templateService: TemplateService;    beforeEach(() => {     templateService = new TemplateService();   });    describe('template creation', () => {     it('should create invoice template', () => {       const input: TemplateCreateInput = {         name: 'Standard Invoice',         type: 'invoice',         body: '<h1>Invoice {{invoiceNumber}}</h1>',       };        expect(input.type).toBe('invoice');       expect(input.body).toContain('{{');     });      it('should create email template', () => {       const input: TemplateCreateInput = {         name: 'Invoice Email',         type: 'email',         subject: 'Your Invoice {{invoiceNumber}}',         body: 'Dear {{customerName}}, please find your invoice attached.',       };        expect(input.type).toBe('email');       expect(input.subject).toBeDefined();     });      it('should create SMS template', () => {       const input: TemplateCreateInput = {         name: 'Payment Reminder',         type: 'sms',         body: 'Reminder: Invoice {{invoiceNumber}} is due on {{dueDate}}',       };        expect(input.type).toBe('sms');       expect(input.body.length).toBeLessThanOrEqual(160);     });      it('should create reminder template', () => {       const input: TemplateCreateInput = {         name: 'Overdue Reminder',         type: 'reminder',         body: 'Invoice {{invoiceNumber}} is now overdue',       };        expect(input.type).toBe('reminder');     });   });    describe('template variables', () => {     it('should support invoice template variables', () => {       const variables = [         'invoiceNumber', 'invoiceDate', 'dueDate', 'companyName', 'companyNIP',         'customerName', 'customerEmail', 'totalAmount', 'taxAmount', 'items'       ];        variables.forEach(variable => {         expect(variable).toBeTruthy();       });     });      it('should support email template variables', () => {       const variables = [         'recipientName', 'recipientEmail', 'subject', 'message',         'actionUrl', 'companyName', 'senderName'       ];        variables.forEach(variable => {         expect(variable).toBeTruthy();       });     });      it('should validate variable syntax with handlebars', () => {       const validVariables = [         '{{invoiceNumber}}',         '{{customer.name}}',         '{{#each items}}{{name}}{{/each}}',       ];        const handlebarsRegex = /\{\{[^}]+\}\}/;        validVariables.forEach(variable => {         expect(handlebarsRegex.test(variable)).toBe(true);       });     });      it('should escape special characters in variables', () => {       const unsafeContent = '<script>alert("XSS")</script>';       const safeContent = '&lt;script&gt;alert(&quot;XSS&quot;)&lt;/script&gt;';        expect(unsafeContent).not.toBe(safeContent);       expect(unsafeContent).toContain('<');       expect(safeContent).toContain('&lt;');     });   });    describe('template rendering', () => {     it('should render template with variables', () => {       const template = 'Invoice {{invoiceNumber}} for {{customerName}}';       const variables = {         invoiceNumber: 'INV-2024-001',         customerName: 'John Doe',       };        const rendered = template         .replace('{{invoiceNumber}}', variables.invoiceNumber)         .replace('{{customerName}}', variables.customerName);        expect(rendered).toContain('INV-2024-001');       expect(rendered).toContain('John Doe');     });      it('should handle missing variables with fallback', () => {       const input: TemplateRenderInput = {         variables: { invoiceNumber: 'INV-001' },         fallbackValues: { customerName: 'Valued Customer' },       };        expect(input.fallbackValues?.customerName).toBe('Valued Customer');     });      it('should support conditional blocks', () => {       const template = '{{#if premium}}Premium features available{{/if}}';       expect(template).toContain('{{#if');       expect(template).toContain('{{/if}}');     });      it('should support loops in templates', () => {       const template = '{{#each items}}<li>{{name}} - {{price}}</li>{{/each}}';       expect(template).toContain('{{#each');       expect(template).toContain('{{/each}}');     });   });    describe('template validation', () => {     it('should validate template syntax', () => {       const validTemplate = '<h1>{{title}}</h1><p>{{content}}</p>';       const invalidTemplate = '<h1>{{title</h1>'; // Unclosed variable        const isValid = (template: string) => {         const openCount = (template.match(/\{\{/g) || []).length;         const closeCount = (template.match(/\}\}/g) || []).length;         return openCount === closeCount;       };        expect(isValid(validTemplate)).toBe(true);       expect(isValid(invalidTemplate)).toBe(false);     });      it('should prevent injection attacks', () => {       const maliciousVariable = '{{process.exit()}}';       expect(maliciousVariable).toContain('{{');       expect(maliciousVariable).not.toContain('process.exit()'); // Should be escaped     });      it('should sanitize HTML content', () => {       const unsafeHTML = '<img src=x onerror="alert(1)">';       expect(unsafeHTML).toContain('onerror');              // Safe version would remove event handlers       const safeHTML = '<img src=x>';       expect(safeHTML).not.toContain('onerror');     });   });    describe('template management', () => {     it('should set default template', () => {       const input: TemplateCreateInput = {         name: 'Default Invoice',         type: 'invoice',         body: '<h1>Invoice</h1>',         isDefault: true,       };        expect(input.isDefault).toBe(true);     });      it('should store template description', () => {       const input: TemplateCreateInput = {         name: 'Template',         type: 'invoice',         body: 'content',         description: 'Standard invoice template for all companies',       };        expect(input.description).toBeDefined();     });      it('should store template settings', () => {       const input: TemplateCreateInput = {         name: 'Template',         type: 'email',         body: 'content',         settings: {           fontSize: 12,           fontFamily: 'Arial',           colors: { primary: '#0000FF', secondary: '#FF0000' },         },       };        expect(input.settings).toBeDefined();       expect(input.settings?.fontSize).toBe(12);     });   });    describe('template updates', () => {     it('should update template content', () => {       let template = { body: 'Old content' };       template.body = 'New content';        expect(template.body).toBe('New content');     });      it('should track template versions', () => {       const versions = [         { id: 'v1', body: 'Version 1', createdAt: new Date('2024-01-01') },         { id: 'v2', body: 'Version 2', createdAt: new Date('2024-01-15') },       ];        expect(versions).toHaveLength(2);       expect(versions[1].createdAt > versions[0].createdAt).toBe(true);     });   });    describe('template retrieval', () => {     it('should fetch template by ID', () => {       const templateId = 'mocked-uuid-v4';       expect(templateId).toBeDefined();     });      it('should list templates by type', () => {       const templates = [         { type: 'invoice', id: 'tmpl-1' },         { type: 'email', id: 'tmpl-2' },         { type: 'invoice', id: 'tmpl-3' },       ];        const invoiceTemplates = templates.filter(t => t.type === 'invoice');       expect(invoiceTemplates).toHaveLength(2);     });      it('should get default template for type', () => {       const templates = [         { type: 'invoice', isDefault: false },         { type: 'invoice', isDefault: true },         { type: 'email', isDefault: true },       ];        const defaultInvoice = templates.find(t => t.type === 'invoice' && t.isDefault);       expect(defaultInvoice).toBeDefined();     });   });    describe('SMS template constraints', () => {     it('should enforce 160 character limit for SMS', () => {       const shortSMS = 'Your invoice INV-001 is ready. Total: 100 PLN';       const longSMS = 'A'.repeat(200);        expect(shortSMS.length).toBeLessThanOrEqual(160);       expect(longSMS.length).toBeGreaterThan(160);     });   });    describe('email template components', () => {     it('should support subject line in email templates', () => {       const input: TemplateCreateInput = {         name: 'Email',         type: 'email',         subject: 'Invoice {{invoiceNumber}}',         body: 'Your invoice',       };        expect(input.subject).toBeDefined();       expect(input.subject).toContain('{{');     });      it('should support HTML and plain text', () => {       const template = {         html: '<h1>Invoice</h1>',         text: 'Invoice',       };        expect(template.html).toContain('<');       expect(template.text).not.toContain('<');     });   }); });
